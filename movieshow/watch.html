<!DOCTYPE html>
<html lang="rw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieShow - Soma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <!-- Barre de navigation supérieure -->
    <nav class="top-nav watch-nav">
        <div class="nav-container">
            <a href="javascript:history.back()" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="logo-center">
                <img src="logo.png" alt="MovieShow Logo" class="nav-logo">
                <span class="page-title" id="watch-title">Soma</span>
            </div>
            <div class="nav-actions">
                <button class="share-btn" id="share-btn">
                    <i class="fas fa-share-alt"></i>
                </button>
                <button class="fullscreen-btn" id="fullscreen-btn">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="watch-content">
        <!-- Lecteur vidéo -->
        <div class="video-container">
            <div class="player-wrapper">
                <!-- Chargement du lecteur -->
                <div class="player-loading" id="player-loading">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Irasa film...</p>
                    </div>
                </div>
                
                <!-- Lecteur vidéo -->
                <div class="video-player" id="video-player">
                    <iframe 
                        id="video-iframe"
                        class="video-frame"
                        frameborder="0"
                        allowfullscreen
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    ></iframe>
                </div>
                
                <!-- Contrôles du lecteur -->
                <div class="player-controls">
                    <div class="controls-top">
                        <div class="video-info-mini">
                            <h3 id="video-title-mini">...</h3>
                            <div class="video-meta-mini">
                                <span id="video-year-mini">2024</span>
                                <span id="video-genre-mini">Drama</span>
                                <span id="video-rating-mini">
                                    <i class="fas fa-star"></i> 0.0
                                </span>
                            </div>
                        </div>
                        <button class="quality-btn" id="quality-btn">
                            <i class="fas fa-hd"></i> HD
                        </button>
                    </div>
                    
                    <div class="controls-middle">
                        <button class="control-btn" id="rewind-btn">
                            <i class="fas fa-backward"></i>
                            <span>10s</span>
                        </button>
                        <button class="control-btn play-btn" id="play-pause-btn">
                            <i class="fas fa-play" id="play-icon"></i>
                            <span id="play-text">Soma</span>
                        </button>
                        <button class="control-btn" id="forward-btn">
                            <i class="fas fa-forward"></i>
                            <span>10s</span>
                        </button>
                    </div>
                    
                    <div class="controls-bottom">
                        <div class="progress-container">
                            <div class="progress-bar" id="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                                <div class="progress-thumb" id="progress-thumb"></div>
                            </div>
                            <div class="time-display">
                                <span id="current-time">0:00</span>
                                <span id="duration">0:00</span>
                            </div>
                        </div>
                        
                        <div class="volume-container">
                            <button class="volume-btn" id="volume-btn">
                                <i class="fas fa-volume-up" id="volume-icon"></i>
                            </button>
                            <div class="volume-slider" id="volume-slider">
                                <div class="volume-level" id="volume-level"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Avertissement publicitaire -->
                <div class="ad-warning" id="ad-warning">
                    <div class="ad-warning-content">
                        <i class="fas fa-ad"></i>
                        <div class="ad-text">
                            <strong>Icyitonderwa:</strong> Mu buryo bwa bidasabwe, amatangazo azaboneka.
                            <span id="ad-timer">Amatangazo azagaragara mu: <span id="ad-countdown">15:00</span></span>
                        </div>
                        <button class="ad-skip-btn" id="ad-skip-btn">
                            <i class="fas fa-crown"></i> Reka amatangazo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Informations détaillées -->
            <div class="video-details" id="video-details">
                <div class="details-header">
                    <h1 id="video-title">...</h1>
                    <div class="video-meta">
                        <span class="video-badge" id="video-badge">NEW</span>
                        <span class="video-year" id="video-year">2024</span>
                        <span class="video-genre" id="video-genre">Drama</span>
                        <span class="video-rating">
                            <i class="fas fa-star"></i>
                            <span id="video-rating-value">0.0</span>/10
                        </span>
                        <span class="video-duration" id="video-duration">
                            <i class="fas fa-clock"></i> 0h 00m
                        </span>
                    </div>
                </div>
                
                <div class="details-body">
                    <div class="synopsis-section">
                        <h3><i class="fas fa-file-alt"></i> Ingingo</h3>
                        <p id="video-description">...</p>
                    </div>
                    
                    <div class="cast-section">
                        <h3><i class="fas fa-users"></i> Abakinnyi</h3>
                        <div class="cast-list" id="cast-list">
                            <!-- Cast chargé dynamiquement -->
                        </div>
                    </div>
                    
                    <!-- Pour les séries TV : sélecteur d'épisode -->
                    <div class="episode-selector hidden" id="episode-selector">
                        <h3><i class="fas fa-list-ol"></i> Amasomo</h3>
                        <div class="season-selector">
                            <select id="season-select" class="season-select">
                                <option value="1">Igihe 1</option>
                            </select>
                        </div>
                        <div class="episodes-grid" id="episodes-grid">
                            <!-- Épisodes chargés dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section films similaires -->
        <div class="similar-section">
            <div class="section-header">
                <h2><i class="fas fa-film"></i> Filimu nka iyi</h2>
            </div>
            <div class="similar-carousel" id="similar-carousel">
                <!-- Films similaires chargés dynamiquement -->
            </div>
        </div>
        
        <!-- Bouton de téléchargement -->
        <div class="download-section">
            <div class="download-card">
                <div class="download-info">
                    <i class="fas fa-download"></i>
                    <div class="download-text">
                        <h3>Kurura iyi film</h3>
                        <p>Kurura kuri terefone yawe, soma nta buhererekane</p>
                    </div>
                </div>
                <button class="download-btn" id="download-btn" disabled>
                    <i class="fas fa-lock"></i>
                    <span>Kurura (Bihagije)</span>
                    <span class="premium-badge"><i class="fas fa-crown"></i> Hakeneye Kwishyura</span>
                </button>
            </div>
            
            <div class="premium-promo">
                <div class="promo-content">
                    <i class="fas fa-gem"></i>
                    <div class="promo-text">
                        <h4>Kurura byose ubusa</h4>
                        <p>Hitamo <strong>Kwishyura</strong> kugirango ukure film n'imiseke byose ubusa</p>
                    </div>
                    <button class="upgrade-now-btn" id="upgrade-now-btn">
                        <i class="fas fa-crown"></i> Hindura none
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Barre de navigation inférieure -->
    <nav class="bottom-nav">
        <div class="bottom-nav-container">
            <a href="home-free.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Intangiriro</span>
            </a>
            
            <a href="movies.html" class="nav-item">
                <i class="fas fa-film"></i>
                <span>Filimu</span>
            </a>
            
            <a href="tvshows.html" class="nav-item">
                <i class="fas fa-tv"></i>
                <span>Imiseke</span>
            </a>
            
            <div class="nav-item menu-item" id="hamburger-menu">
                <i class="fas fa-bars"></i>
                <span>Menu</span>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <h3><i class="fas fa-info-circle"></i> Iyi film</h3>
                        <a href="#" class="dropdown-link" id="report-link">
                            <i class="fas fa-flag"></i> Tangaza ikibazo
                        </a>
                        <a href="#" class="dropdown-link" id="quality-link">
                            <i class="fas fa-cog"></i> Hindura ubwiza
                        </a>
                        <a href="#" class="dropdown-link" id="subtitles-link">
                            <i class="fas fa-closed-captioning"></i> Amagambo
                        </a>
                    </div>
                    
                    <div class="dropdown-section">
                        <h3><i class="fas fa-cog"></i> Igenamiterere</h3>
                        <a href="#" class="dropdown-link" id="privacy-link">
                            <i class="fas fa-user-shield"></i> Amabanga
                        </a>
                        <a href="#" class="dropdown-link" id="help-link">
                            <i class="fas fa-question-circle"></i> Ubufasha
                        </a>
                        <div class="dropdown-link language-selector">
                            <i class="fas fa-language"></i> Ururimi
                            <select id="language-select" class="lang-select">
                                <option value="rw">Kinyarwanda</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <a href="#" class="dropdown-link" id="upgrade-link">
                            <i class="fas fa-crown"></i> Hindura ujye mu Kwishyura
                        </a>
                    </div>
                    
                    <div class="dropdown-footer">
                        <div class="plan-info">
                            <span class="plan-badge" id="current-plan-badge">Ubusa</span>
                            <span class="plan-expiry">Ushobora kureka amatangazo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Script Firebase et configuration -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            get, 
            child,
            query,
            orderByChild,
            limitToLast
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBaSYX1axaZrfQG2GB68LpqDYfYiVZamwE",
            authDomain: "movieshow-80226.firebaseapp.com",
            projectId: "movieshow-80226",
            storageBucket: "movieshow-80226.firebasestorage.app",
            messagingSenderId: "461492912130",
            appId: "1:461492912130:web:e715d40156e57916a1a71b",
            measurementId: "G-SGQZD7TYR0"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Variables globales
        let currentVideo = null;
        let similarVideos = [];
        let isPlaying = false;
        let adTimer = null;
        let adCountdown = 900; // 15 minutes en secondes
        let videoType = 'movie'; // 'movie' ou 'tvshow'
        let currentEpisode = 1;
        let currentSeason = 1;
        let currentVideoUrl = '';
        
        // Fonction principale de chargement
        async function loadVideoData() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            videoType = urlParams.get('type') || 'movie';
            
            if (!videoId) {
                window.location.href = 'home-free.html';
                return;
            }
            
            try {
                // Déterminer la collection selon le type
                const collection = videoType === 'tvshow' ? 'tvshows' : 'movies';
                const videoRef = ref(database, `${collection}/${videoId}`);
                
                // Charger la vidéo principale
                const snapshot = await get(videoRef);
                
                if (snapshot.exists()) {
                    currentVideo = {
                        id: videoId,
                        ...snapshot.val()
                    };
                    
                    console.log("Vidéo chargée:", currentVideo);
                    
                    // Afficher les informations
                    displayVideoInfo();
                    
                    // Charger les vidéos similaires
                    loadSimilarVideos();
                    
                    // Configurer le lecteur
                    setupVideoPlayer();
                    
                    // Démarrer le timer d'ads si en mode gratuit
                    startAdTimer();
                    
                    // Masquer le loader
                    document.getElementById('player-loading').style.display = 'none';
                } else {
                    console.error("Vidéo non trouvée");
                    showError("Filimu ntabonetse");
                }
            } catch (error) {
                console.error("Erreur de chargement:", error);
                showError("Ikosa ry'ubuhererekane");
            }
        }
        
        // Afficher les informations de la vidéo
        function displayVideoInfo() {
            if (!currentVideo) return;
            
            // Titre
            document.getElementById('video-title').textContent = currentVideo.title || 'Filimu idasanzwe';
            document.getElementById('video-title-mini').textContent = currentVideo.title || 'Filimu idasanzwe';
            document.getElementById('watch-title').textContent = currentVideo.title?.substring(0, 20) + '...' || 'Soma';
            
            // Métadonnées
            const year = currentVideo.date ? currentVideo.date.substring(0, 4) : '2024';
            document.getElementById('video-year').textContent = year;
            document.getElementById('video-year-mini').textContent = year;
            
            const genre = currentVideo.genre || 'Drama';
            document.getElementById('video-genre').textContent = genre;
            document.getElementById('video-genre-mini').textContent = genre;
            
            // Badge
            const badgeElement = document.getElementById('video-badge');
            badgeElement.textContent = currentVideo.badge || 'NEW';
            badgeElement.className = 'video-badge ' + (currentVideo.badge ? currentVideo.badge.toLowerCase() : 'new');
            
            // Note
            const rating = currentVideo.rating || '7.5';
            document.getElementById('video-rating-value').textContent = rating;
            document.getElementById('video-rating-mini').innerHTML = `<i class="fas fa-star"></i> ${rating}`;
            
            // Description
            document.getElementById('video-description').textContent = 
                currentVideo.description || 'Filimu nziza yerekana ibintu byiza.';
            
            // Durée
            if (currentVideo.duration) {
                const hours = Math.floor(currentVideo.duration / 60);
                const minutes = currentVideo.duration % 60;
                document.getElementById('video-duration').innerHTML = 
                    `<i class="fas fa-clock"></i> ${hours}h ${minutes}m`;
            }
            
            // Cast
            displayCast(currentVideo.cast || []);
            
            // Pour les séries TV
            if (videoType === 'tvshow') {
                setupTvShowFeatures();
            }
            
            // Plan de l'utilisateur
            const userPlan = localStorage.getItem('movieshow_plan') || 'free';
            const planBadge = document.getElementById('current-plan-badge');
            planBadge.textContent = userPlan === 'free' ? 'Ubusa' : 'Kwishyura';
            planBadge.className = 'plan-badge ' + (userPlan === 'free' ? 'free' : 'premium');
            
            if (userPlan === 'premium') {
                document.getElementById('ad-warning').style.display = 'none';
                document.getElementById('download-btn').disabled = false;
                document.getElementById('download-btn').innerHTML = `
                    <i class="fas fa-download"></i>
                    <span>Kurura</span>
                `;
            }
        }
        
        // Afficher le casting
        function displayCast(castArray) {
            const castList = document.getElementById('cast-list');
            castList.innerHTML = '';
            
            if (!castArray || castArray.length === 0) {
                castList.innerHTML = `
                    <div class="empty-cast">
                        <i class="fas fa-user-slash"></i>
                        <p>Nta makinnyi yanditswe</p>
                    </div>
                `;
                return;
            }
            
            // Prendre les 6 premiers acteurs
            castArray.slice(0, 6).forEach(actor => {
                const castItem = document.createElement('div');
                castItem.className = 'cast-item';
                castItem.innerHTML = `
                    <div class="cast-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="cast-info">
                        <strong>${actor.name || 'Umukinnyi'}</strong>
                        <span>${actor.character || 'Umunyakuri'}</span>
                    </div>
                `;
                castList.appendChild(castItem);
            });
        }
        
        // Configurer les fonctionnalités spécifiques aux séries TV
        function setupTvShowFeatures() {
            document.getElementById('episode-selector').classList.remove('hidden');
            
            // Configurer les saisons
            const seasons = currentVideo.seasons || 1;
            const seasonSelect = document.getElementById('season-select');
            seasonSelect.innerHTML = '';
            
            for (let i = 1; i <= seasons; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Igihe ${i}`;
                seasonSelect.appendChild(option);
            }
            
            // Charger les épisodes
            loadEpisodes();
            
            // Écouter les changements de saison
            seasonSelect.addEventListener('change', function() {
                currentSeason = parseInt(this.value);
                loadEpisodes();
            });
        }
        
        // Charger les épisodes
        async function loadEpisodes() {
            const episodesGrid = document.getElementById('episodes-grid');
            episodesGrid.innerHTML = '<div class="loading-episodes">Irasa amasomo...</div>';
            
            try {
                // Essayer de charger les épisodes depuis Firebase
                const episodesRef = ref(database, `tvshows/${currentVideo.id}/episodes`);
                const snapshot = await get(episodesRef);
                
                let episodes = [];
                
                if (snapshot.exists()) {
                    // Épisodes organisés par saison
                    const data = snapshot.val();
                    if (data[`season${currentSeason}`]) {
                        episodes = Object.entries(data[`season${currentSeason}`]).map(([id, episode]) => ({
                            id,
                            ...episode
                        }));
                    }
                }
                
                // Si pas d'épisodes dans Firebase, en générer des fictifs
                if (episodes.length === 0) {
                    episodes = generateMockEpisodes();
                }
                
                // Afficher les épisodes
                displayEpisodes(episodes);
            } catch (error) {
                console.error("Erreur de chargement des épisodes:", error);
                episodesGrid.innerHTML = '<div class="error-episodes">Ikosa ry\'amasomo</div>';
            }
        }
        
        // Générer des épisodes fictifs
        function generateMockEpisodes() {
            const episodes = [];
            const episodeCount = currentVideo.episodes || 12;
            
            for (let i = 1; i <= episodeCount; i++) {
                episodes.push({
                    id: `episode_${i}`,
                    title: `Isomo ${i}`,
                    description: `Isomo rya ${i} ry'igihe ${currentSeason}`,
                    duration: Math.floor(Math.random() * 40) + 20,
                    thumbnail: currentVideo.coverUrl
                });
            }
            
            return episodes;
        }
        
        // Afficher les épisodes
        function displayEpisodes(episodes) {
            const episodesGrid = document.getElementById('episodes-grid');
            episodesGrid.innerHTML = '';
            
            episodes.forEach((episode, index) => {
                const episodeCard = document.createElement('div');
                episodeCard.className = 'episode-card';
                episodeCard.dataset.episode = index + 1;
                episodeCard.dataset.episodeId = episode.id;
                
                episodeCard.innerHTML = `
                    <div class="episode-thumbnail">
                        <div class="episode-number">${index + 1}</div>
                        <div class="episode-play">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="episode-info">
                        <h4>${episode.title || `Isomo ${index + 1}`}</h4>
                        <p>${episode.description?.substring(0, 50) || ''}...</p>
                        <div class="episode-meta">
                            <span><i class="fas fa-clock"></i> ${episode.duration || 30}m</span>
                            ${index === 0 ? '<span class="watched-badge"><i class="fas fa-eye"></i> Warasomye</span>' : ''}
                        </div>
                    </div>
                `;
                
                episodeCard.addEventListener('click', () => {
                    currentEpisode = index + 1;
                    playEpisode(episode);
                });
                
                episodesGrid.appendChild(episodeCard);
            });
        }
        
        // Jouer un épisode
        function playEpisode(episode) {
            if (!episode) return;
            
            // Mettre à jour l'URL de la vidéo
            if (episode.videoUrl) {
                currentVideoUrl = episode.videoUrl;
            } else if (currentVideo.videoUrl && typeof currentVideo.videoUrl === 'object') {
                // Chercher l'URL par saison/épisode
                const seasonKey = `season${currentSeason}`;
                if (currentVideo.videoUrl[seasonKey] && currentVideo.videoUrl[seasonKey][`episode${currentEpisode}`]) {
                    currentVideoUrl = currentVideo.videoUrl[seasonKey][`episode${currentEpisode}`];
                }
            }
            
            // Mettre à jour le lecteur
            updateVideoPlayer();
            
            // Marquer comme regardé
            markAsWatched();
        }
        
        // Configurer le lecteur vidéo
        function setupVideoPlayer() {
            // Déterminer l'URL de la vidéo
            if (currentVideo.videoUrl) {
                if (typeof currentVideo.videoUrl === 'string') {
                    currentVideoUrl = currentVideo.videoUrl;
                } else if (typeof currentVideo.videoUrl === 'object') {
                    // Pour les séries avec plusieurs épisodes
                    if (videoType === 'tvshow') {
                        currentVideoUrl = currentVideo.videoUrl.season1?.episode1 || 
                                        Object.values(currentVideo.videoUrl)[0];
                    } else {
                        // Pour les films multipart
                        currentVideoUrl = Object.values(currentVideo.videoUrl)[0];
                    }
                }
            }
            
            // Si pas d'URL, utiliser une vidéo de démo
            if (!currentVideoUrl) {
                currentVideoUrl = `https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1`;
            }
            
            // Mettre à jour le lecteur
            updateVideoPlayer();
            
            // Configurer les contrôles
            setupPlayerControls();
        }
        
        // Mettre à jour le lecteur vidéo
        function updateVideoPlayer() {
            const iframe = document.getElementById('video-iframe');
            
            // Détecter le type d'URL et formater correctement
            let finalUrl = currentVideoUrl;
            
            if (currentVideoUrl.includes('youtube.com') || currentVideoUrl.includes('youtu.be')) {
                // URL YouTube
                const videoId = currentVideoUrl.includes('youtu.be') 
                    ? currentVideoUrl.split('/').pop()
                    : new URL(currentVideoUrl).searchParams.get('v');
                finalUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
            } else if (currentVideoUrl.includes('vimeo.com')) {
                // URL Vimeo
                const videoId = currentVideoUrl.split('/').pop();
                finalUrl = `https://player.vimeo.com/video/${videoId}?autoplay=1`;
            } else if (currentVideoUrl.includes('drive.google.com')) {
                // URL Google Drive
                const match = currentVideoUrl.match(/\/d\/([^\/]+)/);
                if (match) {
                    finalUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
                }
            } else if (currentVideoUrl.includes('dailymotion.com')) {
                // URL Dailymotion
                const videoId = currentVideoUrl.split('/').pop().split('_')[0];
                finalUrl = `https://www.dailymotion.com/embed/video/${videoId}?autoplay=1`;
            }
            
            iframe.src = finalUrl;
            console.log("URL vidéo chargée:", finalUrl);
        }
        
        // Configurer les contrôles du lecteur
        function setupPlayerControls() {
            const playBtn = document.getElementById('play-pause-btn');
            const rewindBtn = document.getElementById('rewind-btn');
            const forwardBtn = document.getElementById('forward-btn');
            const volumeBtn = document.getElementById('volume-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const progressBar = document.getElementById('progress-bar');
            const volumeSlider = document.getElementById('volume-slider');
            
            // Play/Pause
            playBtn.addEventListener('click', () => {
                const iframe = document.getElementById('video-iframe');
                const iframeWindow = iframe.contentWindow;
                
                if (!isPlaying) {
                    // Essayer de déclencher la lecture
                    try {
                        iframeWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                    } catch (e) {
                        console.log("Lecture déclenchée");
                    }
                    
                    isPlaying = true;
                    document.getElementById('play-icon').className = 'fas fa-pause';
                    document.getElementById('play-text').textContent = 'Hagarara';
                } else {
                    // Mettre en pause
                    try {
                        iframeWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                    } catch (e) {
                        console.log("Pause déclenchée");
                    }
                    
                    isPlaying = false;
                    document.getElementById('play-icon').className = 'fas fa-play';
                    document.getElementById('play-text').textContent = 'Soma';
                }
            });
            
            // Rewind
            rewindBtn.addEventListener('click', () => {
                const iframe = document.getElementById('video-iframe');
                const iframeWindow = iframe.contentWindow;
                
                try {
                    iframeWindow.postMessage('{"event":"command","func":"seekTo","args":[10, true]}', '*');
                } catch (e) {
                    console.log("Retour arrière");
                }
            });
            
            // Forward
            forwardBtn.addEventListener('click', () => {
                const iframe = document.getElementById('video-iframe');
                const iframeWindow = iframe.contentWindow;
                
                try {
                    iframeWindow.postMessage('{"event":"command","func":"seekTo","args":[10, true]}', '*');
                } catch (e) {
                    console.log("Avance rapide");
                }
            });
            
            // Plein écran
            fullscreenBtn.addEventListener('click', () => {
                const player = document.querySelector('.video-player');
                
                if (!document.fullscreenElement) {
                    if (player.requestFullscreen) {
                        player.requestFullscreen();
                    } else if (player.webkitRequestFullscreen) {
                        player.webkitRequestFullscreen();
                    } else if (player.msRequestFullscreen) {
                        player.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            });
            
            // Simuler la progression
            setInterval(() => {
                if (isPlaying) {
                    const progressFill = document.getElementById('progress-fill');
                    const currentWidth = parseInt(progressFill.style.width) || 0;
                    const newWidth = Math.min(currentWidth + 0.5, 100);
                    progressFill.style.width = newWidth + '%';
                    
                    // Mettre à jour le temps
                    updateTimeDisplay(newWidth);
                }
            }, 1000);
        }
        
        // Mettre à jour l'affichage du temps
        function updateTimeDisplay(percent) {
            const totalSeconds = 3600; // 1 heure par défaut
            const currentSeconds = Math.floor(totalSeconds * percent / 100);
            
            const currentMinutes = Math.floor(currentSeconds / 60);
            const currentSecs = currentSeconds % 60;
            const totalMinutes = Math.floor(totalSeconds / 60);
            const totalSecs = totalSeconds % 60;
            
            document.getElementById('current-time').textContent = 
                `${currentMinutes}:${currentSecs.toString().padStart(2, '0')}`;
            document.getElementById('duration').textContent = 
                `${totalMinutes}:${totalSecs.toString().padStart(2, '0')}`;
        }
        
        // Charger les vidéos similaires
        async function loadSimilarVideos() {
            try {
                const collection = videoType === 'tvshow' ? 'tvshows' : 'movies';
                const videosRef = ref(database, collection);
                const snapshot = await get(videosRef);
                
                if (snapshot.exists()) {
                    const allVideos = [];
                    snapshot.forEach((childSnapshot) => {
                        if (childSnapshot.key !== currentVideo.id) {
                            allVideos.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        }
                    });
                    
                    // Filtrer par genre similaire
                    similarVideos = allVideos.filter(video => 
                        video.genre === currentVideo.genre
                    ).slice(0, 5);
                    
                    // Si pas assez de vidéos du même genre, prendre aléatoirement
                    if (similarVideos.length < 3) {
                        const randomVideos = allVideos
                            .sort(() => Math.random() - 0.5)
                            .slice(0, 5 - similarVideos.length);
                        similarVideos = [...similarVideos, ...randomVideos];
                    }
                    
                    // Afficher les vidéos similaires
                    displaySimilarVideos();
                }
            } catch (error) {
                console.error("Erreur de chargement des vidéos similaires:", error);
            }
        }
        
        // Afficher les vidéos similaires
        function displaySimilarVideos() {
            const carousel = document.getElementById('similar-carousel');
            carousel.innerHTML = '';
            
            if (similarVideos.length === 0) {
                carousel.innerHTML = `
                    <div class="empty-similar">
                        <i class="fas fa-film"></i>
                        <p>Nta film nka iyi</p>
                    </div>
                `;
                return;
            }
            
            similarVideos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'similar-card';
                card.dataset.id = video.id;
                card.dataset.type = videoType;
                
                card.innerHTML = `
                    <div class="similar-image">
                        <div class="similar-badge ${video.badge ? video.badge.toLowerCase() : 'new'}">
                            ${video.badge || 'NEW'}
                        </div>
                        <div class="similar-play">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="similar-info">
                        <h4>${video.title?.substring(0, 20) || 'Filimu'}...</h4>
                        <div class="similar-meta">
                            <span>${video.genre || 'Drama'}</span>
                            <span>${video.date ? video.date.substring(0, 4) : '2024'}</span>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    const userPlan = localStorage.getItem('movieshow_plan');
                    if (userPlan === 'free') {
                        window.open('https://www.effectivegatecpm.com/wu0xndpxcg?key=962747162b526b8e35632b7e46f1e881', '_blank');
                        setTimeout(() => {
                            window.location.href = `watch.html?id=${video.id}&type=${videoType}`;
                        }, 500);
                    } else {
                        window.location.href = `watch.html?id=${video.id}&type=${videoType}`;
                    }
                });
                
                carousel.appendChild(card);
            });
        }
        
        // Démarrer le timer d'ads
        function startAdTimer() {
            const userPlan = localStorage.getItem('movieshow_plan');
            
            if (userPlan === 'free') {
                adTimer = setInterval(() => {
                    adCountdown--;
                    
                    // Mettre à jour l'affichage
                    const minutes = Math.floor(adCountdown / 60);
                    const seconds = adCountdown % 60;
                    document.getElementById('ad-countdown').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Si le temps est écoulé
                    if (adCountdown <= 0) {
                        clearInterval(adTimer);
                        showAd();
                    }
                }, 1000);
            }
        }
        
        // Afficher une publicité
        function showAd() {
            window.open('https://www.effectivegatecpm.com/wu0xndpxcg?key=962747162b526b8e35632b7e46f1e881', '_blank');
            
            // Redémarrer le timer
            adCountdown = 900; // 15 minutes
            startAdTimer();
        }
        
        // Marquer comme regardé
        function markAsWatched() {
            // Implémenter la logique de suivi
            console.log(`Épisode ${currentEpisode} de la saison ${currentSeason} marqué comme regardé`);
        }
        
        // Afficher une erreur
        function showError(message) {
            document.getElementById('player-loading').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>${message}</h3>
                    <button onclick="window.location.href='home-free.html'" class="retry-btn">
                        <i class="fas fa-home"></i> Subira ku ntangiriro
                    </button>
                </div>
            `;
        }
        
        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si l'utilisateur a choisi un plan
            const userPlan = localStorage.getItem('movieshow_plan');
            if (!userPlan) {
                window.location.href = 'index.html';
                return;
            }
            
            // Charger la langue sauvegardée
            const savedLang = localStorage.getItem('movieshow_lang') || 'rw';
            document.getElementById('language-select').value = savedLang;
            
            // Initialiser les événements
            initEvents();
            
            // Charger les données de la vidéo
            loadVideoData();
        });
        
        // Fonction pour initialiser les événements
        function initEvents() {
            // Gestion du menu hamburger
            document.getElementById('hamburger-menu').addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = this.querySelector('.dropdown-menu');
                dropdown.classList.toggle('show');
            });

            document.addEventListener('click', function() {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            });

            // Changement de langue
            document.getElementById('language-select').addEventListener('change', function() {
                const lang = this.value;
                localStorage.setItem('movieshow_lang', lang);
                // updateLanguage(lang); // À implémenter
            });

            // Bouton de mise à niveau
            document.getElementById('upgrade-now-btn').addEventListener('click', function() {
                localStorage.setItem('movieshow_plan', 'premium');
                alert('Ujyanye no kwishyura uzakorwa vuba. Kuva none, ujye mu buryo bwa bidasabwe.');
                window.location.reload();
            });

            document.getElementById('upgrade-link').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.setItem('movieshow_plan', 'premium');
                alert('Ujyanye no kwishyura uzakorwa vuba. Kuva none, ujye mu buryo bwa bidasabwe.');
                window.location.reload();
            });

            // Bouton pour sauter les ads
            document.getElementById('ad-skip-btn').addEventListener('click', function() {
                localStorage.setItem('movieshow_plan', 'premium');
                alert('Ujyanye no kwishyura uzakorwa vuba. Kuva none, ujye mu buryo bwa bidasabwe.');
                window.location.reload();
            });

            // Bouton de partage
            document.getElementById('share-btn').addEventListener('click', function() {
                if (navigator.share) {
                    navigator.share({
                        title: currentVideo?.title || 'MovieShow',
                        text: 'Reba film nziza kuri MovieShow',
                        url: window.location.href
                    });
                } else {
                    // Fallback pour les navigateurs sans Web Share API
                    navigator.clipboard.writeText(window.location.href);
                    alert('Umurongo wakoporowe!');
                }
            });
        }
    </script>
</body>
</html>