<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch - MovieShow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(rgba(10, 25, 41, 0.95), rgba(13, 27, 42, 0.98));
            min-height: 100vh;
            color: #ffffff;
            line-height: 1.5;
        }
        
        /* TOP NAVIGATION */
        .top-nav {
            background: rgba(10, 25, 41, 0.98);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(32, 201, 151, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .logo-container img {
            height: 35px;
            filter: drop-shadow(0 0 8px rgba(32, 201, 151, 0.4));
        }
        
        .back-btn {
            background: rgba(32, 201, 151, 0.15);
            border: 1px solid rgba(32, 201, 151, 0.3);
            color: #20c997;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(32, 201, 151, 0.25);
            transform: translateX(-3px);
        }
        
        /* MAIN CONTENT */
        .main-content {
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* VIDEO PLAYER SECTION */
        .video-section {
            margin-bottom: 25px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            background: #000;
        }
        
        .video-container {
            position: relative;
            background: #000;
        }
        
        .video-player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a1929, #1a202c);
            color: #a0aec0;
        }
        
        .video-placeholder i {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #20c997;
            opacity: 0.7;
        }
        
        /* AD NOTIFICATION */
        .ad-notice {
            background: linear-gradient(135deg, rgba(32, 201, 151, 0.1), rgba(255, 209, 0, 0.1));
            border: 1px solid rgba(32, 201, 151, 0.3);
            border-radius: 10px;
            padding: 12px 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: #cbd5e0;
            animation: pulse 2s infinite;
        }
        
        .ad-notice i {
            color: #ffd100;
            font-size: 1.2rem;
        }
        
        /* VIDEO INFO */
        .video-info {
            background: rgba(26, 32, 44, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .video-title {
            font-size: 1.6rem;
            margin-bottom: 12px;
            color: #fff;
            line-height: 1.3;
        }
        
        .video-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meta-icon {
            color: #20c997;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }
        
        .meta-text {
            color: #cbd5e0;
            font-size: 0.9rem;
        }
        
        .meta-label {
            display: block;
            font-size: 0.75rem;
            color: #a0aec0;
            margin-bottom: 4px;
        }
        
        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge.new {
            background: linear-gradient(135deg, #20c997, #38b2ac);
            color: #0a1929;
        }
        
        .badge.french {
            background: linear-gradient(135deg, #3182ce, #63b3ed);
            color: white;
        }
        
        .badge.english {
            background: linear-gradient(135deg, #e53e3e, #fc8181);
            color: white;
        }
        
        .video-description {
            color: #cbd5e0;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .cast-info {
            color: #a0aec0;
            font-size: 0.9rem;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ACTIONS SECTION */
        .actions-section {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #20c997, #38b2ac);
            color: white;
        }
        
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(32, 201, 151, 0.3);
        }
        
        .download-btn {
            background: rgba(45, 55, 72, 0.9);
            color: #a0aec0;
            border: 1px solid #4a5568;
            position: relative;
            min-width: 140px;
        }
        
        .download-btn.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .download-btn.disabled::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #e53e3e;
            border-radius: 12px;
            animation: borderPulse 2s infinite;
        }
        
        .premium-only {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e53e3e;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* EPISODE SELECTOR */
        .episode-section {
            background: rgba(26, 32, 44, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
        }
        
        .episode-section.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        .episode-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        
        .episode-btn {
            padding: 10px;
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid #4a5568;
            border-radius: 8px;
            color: #a0aec0;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .episode-btn:hover {
            background: rgba(32, 201, 151, 0.1);
            color: #20c997;
            border-color: #20c997;
        }
        
        .episode-btn.active {
            background: #20c997;
            color: #0a1929;
            border-color: #20c997;
            font-weight: bold;
        }
        
        /* SIMILAR CONTENT */
        .similar-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .similar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }
        
        .similar-card {
            background: rgba(26, 32, 44, 0.9);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .similar-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .similar-poster {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: linear-gradient(135deg, #2d3748, #4a5568);
        }
        
        .similar-info {
            padding: 12px;
        }
        
        .similar-title {
            font-size: 0.9rem;
            color: #fff;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .similar-meta {
            font-size: 0.75rem;
            color: #a0aec0;
        }
        
        /* LOADING & ERROR STATES */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 25, 41, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(32, 201, 151, 0.2);
            border-top: 4px solid #20c997;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .error-message {
            background: rgba(229, 62, 62, 0.1);
            border: 1px solid rgba(229, 62, 62, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            color: #fc8181;
            display: none;
        }
        
        .error-message.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ANIMATIONS */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(32, 201, 151, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(32, 201, 151, 0); }
            100% { box-shadow: 0 0 0 0 rgba(32, 201, 151, 0); }
        }
        
        @keyframes borderPulse {
            0%, 100% { border-color: rgba(229, 62, 62, 0.5); }
            50% { border-color: rgba(229, 62, 62, 0.8); }
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .video-title {
                font-size: 1.4rem;
            }
            
            .actions-section {
                grid-template-columns: 1fr;
            }
            
            .download-btn {
                width: 100%;
            }
            
            .similar-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .similar-poster {
                height: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .video-meta-grid {
                grid-template-columns: 1fr;
            }
            
            .video-title {
                font-size: 1.2rem;
            }
            
            .similar-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .similar-poster {
                height: 100px;
            }
            
            .action-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo-container">
            <img src="logo.png" alt="MovieShow">
        </div>
        <button class="back-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
            Back
        </button>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Ad Notice -->
        <div class="ad-notice" id="adNotice">
            <i class="fas fa-ad"></i>
            <span>Free users: Ads support our service. They may appear in new tabs during playback.</span>
        </div>

        <!-- Video Section -->
        <div class="video-section">
            <div class="video-container" id="videoContainer">
                <div class="video-player" id="videoPlayer">
                    <div class="video-placeholder">
                        <i class="fas fa-play-circle"></i>
                        <p>Click Play to start watching</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Episode Selector (for TV shows) -->
        <div class="episode-section" id="episodeSection">
            <h3 class="episode-title">
                <i class="fas fa-list-ol"></i>
                Episodes
            </h3>
            <div class="episode-grid" id="episodeGrid">
                <!-- Episodes loaded dynamically -->
            </div>
        </div>

        <!-- Video Info -->
        <div class="video-info">
            <h1 class="video-title" id="videoTitle">Loading Title...</h1>
            
            <div class="video-meta-grid">
                <div class="meta-item">
                    <div class="meta-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div>
                        <span class="meta-label">Year</span>
                        <span class="meta-text" id="videoYear">2023</span>
                    </div>
                </div>
                
                <div class="meta-item">
                    <div class="meta-icon">
                        <i class="fas fa-film"></i>
                    </div>
                    <div>
                        <span class="meta-label">Genre</span>
                        <span class="meta-text" id="videoGenre">Action, Adventure</span>
                    </div>
                </div>
                
                <div class="meta-item">
                    <div class="meta-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <span class="meta-label">Duration</span>
                        <span class="meta-text" id="videoDuration">2h 15m</span>
                    </div>
                </div>
                
                <div class="meta-item">
                    <div class="meta-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div>
                        <span class="meta-label">Rating</span>
                        <span class="meta-text" id="videoRating">8.5/10</span>
                    </div>
                </div>
            </div>

            <div class="badge-container" id="badgeContainer">
                <!-- Badges loaded dynamically -->
            </div>

            <p class="video-description" id="videoDescription">
                Loading description...
            </p>

            <div class="cast-info">
                <strong><i class="fas fa-users"></i> Cast:</strong> 
                <span id="videoCast">Loading cast information...</span>
            </div>
        </div>

        <!-- Actions Section -->
        <div class="actions-section">
            <button class="action-btn play-btn" onclick="playVideo()" id="playBtn">
                <i class="fas fa-play"></i>
                Play Now
            </button>
            
            <button class="action-btn download-btn disabled" id="downloadBtn" onclick="handleDownload()">
                <i class="fas fa-download"></i>
                Download
                <span class="premium-only">PREMIUM</span>
            </button>
        </div>

        <!-- Similar Content -->
        <div class="similar-section">
            <h2 class="section-title">
                <i class="fas fa-film"></i>
                Similar Content
            </h2>
            <div class="similar-grid" id="similarGrid">
                <!-- Similar content loaded dynamically -->
                <div class="similar-card placeholder">
                    <div class="similar-poster"></div>
                    <div class="similar-info">
                        <div class="similar-title">Loading...</div>
                        <div class="similar-meta">Action ‚Ä¢ 2023</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Content</h3>
            <p id="errorText">Unable to load video data. Please check your connection.</p>
            <button onclick="retryLoading()" style="
                margin-top: 15px;
                padding: 10px 20px;
                background: #20c997;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            ">
                Retry
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p style="color: #cbd5e0; margin-top: 15px;">Loading content...</p>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBaSYX1axaZrfQG2GB68LpqDYfYiVZamwE",
            authDomain: "movieshow-80226.firebaseapp.com",
            databaseURL: "https://movieshow-80226-default-rtdb.firebaseio.com",
            projectId: "movieshow-80226",
            storageBucket: "movieshow-80226.firebasestorage.app",
            messagingSenderId: "461492912130",
            appId: "1:461492912130:web:e715d40156e57916a1a71b",
            measurementId: "G-SGQZD7TYR0"
        };

        // ==================== GLOBAL VARIABLES ====================
        let db = null;
        let currentPlan = 'free';
        let currentVideo = null;
        let similarContent = [];
        let videoType = 'movie';
        let videoId = null;
        let currentEpisode = 1;
        let adTimer = null;
        let isPlaying = false;

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            try {
                showLoading(true);
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                videoType = urlParams.get('type') || 'movie';
                videoId = urlParams.get('id') || '1';
                
                // Get user plan
                currentPlan = localStorage.getItem('movieshow_plan') || 'free';
                
                // Initialize Firebase
                await initializeFirebase();
                
                // Load video data
                await loadVideoData();
                
                // Load similar content
                await loadSimilarContent();
                
                // Update UI based on plan
                updateUIForPlan();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize. Please try again.');
            }
        }

        // ==================== FIREBASE INITIALIZATION ====================
        async function initializeFirebase() {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                throw new Error('Failed to connect to database');
            }
        }

        // ==================== LOAD VIDEO DATA FROM FIREBASE ====================
        async function loadVideoData() {
            try {
                showLoading(true);
                
                // Reference to the video in Firebase
                const videoRef = db.ref(`${videoType}s/${videoId}`);
                
                // Get video data
                const snapshot = await videoRef.once('value');
                
                if (!snapshot.exists()) {
                    throw new Error('Video not found in database');
                }
                
                currentVideo = snapshot.val();
                currentVideo.id = videoId;
                
                // Update UI with video data
                updateVideoUI();
                
                // If it's a TV show with episodes, show episode selector
                if (videoType === 'tvshow' && currentVideo.episodes) {
                    showEpisodeSelector();
                }
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading video:', error);
                showError('Failed to load video. Please check the video ID.');
                return null;
            }
        }

        // ==================== LOAD SIMILAR CONTENT ====================
        async function loadSimilarContent() {
            try {
                const similarRef = db.ref(videoType === 'movie' ? 'movies' : 'tvshows');
                const snapshot = await similarRef.limitToLast(4).once('value');
                
                similarContent = [];
                snapshot.forEach(childSnapshot => {
                    if (childSnapshot.key !== videoId) {
                        similarContent.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    }
                });
                
                // If not enough content, load from both collections
                if (similarContent.length < 4) {
                    const otherType = videoType === 'movie' ? 'tvshows' : 'movies';
                    const otherRef = db.ref(otherType);
                    const otherSnapshot = await otherRef.limitToLast(4 - similarContent.length).once('value');
                    
                    otherSnapshot.forEach(childSnapshot => {
                        similarContent.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val(),
                            type: otherType
                        });
                    });
                }
                
                renderSimilarContent();
                
            } catch (error) {
                console.error('Error loading similar content:', error);
                // Don't show error for similar content, just log it
            }
        }

        // ==================== UPDATE VIDEO UI ====================
        function updateVideoUI() {
            if (!currentVideo) return;
            
            // Update basic info
            document.getElementById('videoTitle').textContent = currentVideo.title || 'Untitled';
            document.getElementById('videoYear').textContent = currentVideo.year || 'N/A';
            document.getElementById('videoGenre').textContent = currentVideo.genre || 'Not specified';
            document.getElementById('videoDuration').textContent = currentVideo.duration || 'N/A';
            document.getElementById('videoRating').textContent = currentVideo.rating || 'N/A';
            document.getElementById('videoDescription').textContent = currentVideo.description || 'No description available.';
            document.getElementById('videoCast').textContent = currentVideo.cast || 'Not specified';
            
            // Update badges
            const badgeContainer = document.getElementById('badgeContainer');
            badgeContainer.innerHTML = '';
            
            if (currentVideo.badge) {
                const badge = document.createElement('span');
                badge.className = `badge ${currentVideo.badge}`;
                badge.textContent = currentVideo.badge.toUpperCase();
                badgeContainer.appendChild(badge);
            }
            
            // Add type badge
            const typeBadge = document.createElement('span');
            typeBadge.className = 'badge';
            typeBadge.style.background = 'linear-gradient(135deg, #805ad5, #9f7aea)';
            typeBadge.textContent = videoType === 'movie' ? 'MOVIE' : 'TV SERIES';
            badgeContainer.appendChild(typeBadge);
            
            // Update download button
            updateDownloadButton();
            
            // Update ad notice visibility
            updateAdNotice();
        }

        // ==================== EPISODE SELECTOR ====================
        function showEpisodeSelector() {
            const episodeSection = document.getElementById('episodeSection');
            const episodeGrid = document.getElementById('episodeGrid');
            
            if (!currentVideo.episodes || currentVideo.episodes.length === 0) {
                return;
            }
            
            episodeSection.classList.add('show');
            
            // Clear previous episodes
            episodeGrid.innerHTML = '';
            
            // Create episode buttons
            currentVideo.episodes.forEach((episode, index) => {
                const episodeBtn = document.createElement('button');
                episodeBtn.className = `episode-btn ${index === 0 ? 'active' : ''}`;
                episodeBtn.textContent = episode.episodeNumber || `Ep ${index + 1}`;
                episodeBtn.onclick = () => selectEpisode(index);
                episodeGrid.appendChild(episodeBtn);
            });
        }

        // ==================== SELECT EPISODE ====================
        function selectEpisode(index) {
            currentEpisode = index;
            
            // Update active state
            document.querySelectorAll('.episode-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            // Get episode data
            const episode = currentVideo.episodes[index];
            
            // Update video URL
            currentVideo.videoUrl = episode.url || currentVideo.videoUrl;
            currentVideo.title = episode.title || currentVideo.title;
            
            // Update UI
            document.getElementById('videoTitle').textContent = episode.title || currentVideo.title;
            document.getElementById('videoDuration').textContent = episode.duration || currentVideo.duration;
            
            // If video is playing, reload it
            if (isPlaying) {
                playVideo();
            }
        }

        // ==================== PLAY VIDEO ====================
        function playVideo() {
            if (!currentVideo || !currentVideo.videoUrl) {
                showError('No video URL available');
                return;
            }
            
            // Show loading
            showLoading(true);
            
            // For free users, show ad before playing
            if (currentPlan === 'free') {
                showAd();
                startAdTimer();
            }
            
            // Create iframe for video
            const videoPlayer = document.getElementById('videoPlayer');
            const videoUrl = getVideoUrl();
            
            videoPlayer.innerHTML = `
                <iframe 
                    src="${videoUrl}" 
                    class="video-player"
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen
                    autoplay="1"
                    onload="videoLoaded()"
                ></iframe>
            `;
            
            isPlaying = true;
            
            // Update play button
            const playBtn = document.getElementById('playBtn');
            playBtn.innerHTML = '<i class="fas fa-pause"></i> Playing';
            playBtn.onclick = pauseVideo;
        }

        // ==================== PAUSE VIDEO ====================
        function pauseVideo() {
            const iframe = document.querySelector('.video-player iframe');
            if (iframe) {
                iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            }
            
            const playBtn = document.getElementById('playBtn');
            playBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            playBtn.onclick = playVideo;
            
            isPlaying = false;
        }

        // ==================== GET VIDEO URL ====================
        function getVideoUrl() {
            if (videoType === 'tvshow' && currentVideo.episodes && currentVideo.episodes[currentEpisode]) {
                return currentVideo.episodes[currentEpisode].url || currentVideo.videoUrl;
            }
            return currentVideo.videoUrl;
        }

        // ==================== VIDEO LOADED CALLBACK ====================
        function videoLoaded() {
            showLoading(false);
        }

        // ==================== AD SYSTEM ====================
        function showAd() {
            if (currentPlan === 'free') {
                // Open ad in new tab
                const adWindow = window.open(
                    'https://www.effectivegatecpm.com/wu0xndpxcg?key=962747162b526b8e35632b7e46f1e881',
                    '_blank'
                );
                
                // Focus back on main window after a moment
                setTimeout(() => {
                    if (adWindow && !adWindow.closed) {
                        window.focus();
                    }
                }, 1000);
            }
        }

        function startAdTimer() {
            if (currentPlan === 'free') {
                // Clear existing timer
                if (adTimer) clearInterval(adTimer);
                
                // Show ad every 3 minutes
                adTimer = setInterval(() => {
                    if (isPlaying) {
                        showAd();
                    }
                }, 180000); // 3 minutes
            }
        }

        // ==================== DOWNLOAD FUNCTIONALITY ====================
        function updateDownloadButton() {
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (currentPlan === 'premium') {
                downloadBtn.classList.remove('disabled');
                downloadBtn.querySelector('.premium-only').style.display = 'none';
                downloadBtn.onclick = downloadVideo;
            } else {
                downloadBtn.classList.add('disabled');
                downloadBtn.querySelector('.premium-only').style.display = 'block';
                downloadBtn.onclick = handleDownload;
            }
        }

        function handleDownload() {
            if (currentPlan === 'free') {
                alert('üîí Download feature is available only for Premium users.\n\nUpgrade to Premium to:\n‚Ä¢ Download videos for offline viewing\n‚Ä¢ Remove all advertisements\n‚Ä¢ Get HD quality\n\nClick OK to learn more about Premium plan.');
                
                // Show ad when trying to download
                showAd();
                
                // Option to redirect to upgrade page
                if (confirm('Would you like to upgrade to Premium now?')) {
                    window.location.href = 'upgrade.html';
                }
            }
        }

        async function downloadVideo() {
            if (currentPlan !== 'premium') {
                handleDownload();
                return;
            }
            
            if (!currentVideo || !currentVideo.videoUrl) {
                alert('Download URL not available');
                return;
            }
            
            showLoading(true);
            
            try {
                // Create download link
                const link = document.createElement('a');
                link.href = getVideoUrl();
                link.download = `${currentVideo.title.replace(/[^a-z0-9]/gi, '_')}.mp4`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Log download in Firebase (optional)
                await logDownload();
                
                alert('‚úÖ Download started! The video will be saved to your downloads folder.');
                
            } catch (error) {
                console.error('Download error:', error);
                alert('‚ùå Download failed. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        async function logDownload() {
            try {
                const downloadsRef = db.ref('downloads');
                await downloadsRef.push({
                    videoId: videoId,
                    videoType: videoType,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userPlan: currentPlan
                });
            } catch (error) {
                console.error('Error logging download:', error);
            }
        }

        // ==================== RENDER SIMILAR CONTENT ====================
        function renderSimilarContent() {
            const similarGrid = document.getElementById('similarGrid');
            
            if (!similarContent || similarContent.length === 0) {
                similarGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-film" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>No similar content found</p>
                    </div>
                `;
                return;
            }
            
            similarGrid.innerHTML = similarContent.map(item => `
                <div class="similar-card" onclick="openSimilar('${item.type || videoType}', '${item.id}')">
                    <img src="${item.coverUrl || 'https://via.placeholder.com/300x200/1a202c/20c997?text=Movie'}" 
                         alt="${item.title}" 
                         class="similar-poster"
                         onerror="this.src='https://via.placeholder.com/300x200/1a202c/20c997?text=Movie'">
                    <div class="similar-info">
                        <h4 class="similar-title">${item.title || 'Untitled'}</h4>
                        <div class="similar-meta">${item.year || 'N/A'} ‚Ä¢ ${item.genre || 'Not specified'}</div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== OPEN SIMILAR CONTENT ====================
        function openSimilar(type, id) {
            showLoading(true);
            
            if (currentPlan === 'free') {
                showAd();
            }
            
            setTimeout(() => {
                window.location.href = `watch.html?type=${type}&id=${id}`;
            }, 300);
        }

        // ==================== UPDATE UI FOR PLAN ====================
        function updateUIForPlan() {
            const adNotice = document.getElementById('adNotice');
            
            if (currentPlan === 'premium') {
                adNotice.style.display = 'none';
            } else {
                adNotice.style.display = 'flex';
            }
            
            updateDownloadButton();
        }

        function updateAdNotice() {
            const adNotice = document.getElementById('adNotice');
            if (currentPlan === 'free' && currentVideo) {
                adNotice.style.display = 'flex';
            }
        }

        // ==================== NAVIGATION ====================
        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = videoType === 'movie' ? 'movies.html' : 'tvshows.html';
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.toggle('show', show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.classList.add('show');
            showLoading(false);
        }

        function retryLoading() {
            document.getElementById('errorMessage').classList.remove('show');
            initializeApp();
        }

        // ==================== INITIALIZE ON LOAD ====================
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (adTimer) {
                    clearInterval(adTimer);
                }
            });
        });

        // ==================== FIREBASE DATA STRUCTURE HELPER ====================
        /*
        Example Firebase data structure for movies:
        
        {
          "movies": {
            "movie1": {
              "title": "The Great Adventure",
              "description": "An epic adventure movie...",
              "year": "2023",
              "genre": "Action, Adventure",
              "duration": "2h 15m",
              "rating": "8.5/10",
              "cast": "John Smith, Jane Doe",
              "badge": "new",
              "coverUrl": "https://example.com/cover.jpg",
              "videoUrl": "https://example.com/video.mp4",
              "dateAdded": "2024-01-01"
            }
          },
          
          "tvshows": {
            "tvshow1": {
              "title": "The Great Series",
              "description": "An exciting TV series...",
              "year": "2023",
              "genre": "Drama, Mystery",
              "episodes": [
                {
                  "episodeNumber": 1,
                  "title": "Episode 1: The Beginning",
                  "url": "https://example.com/ep1.mp4",
                  "duration": "45m"
                }
              ],
              "cast": "Actor 1, Actor 2",
              "badge": "english",
              "coverUrl": "https://example.com/cover.jpg",
              "videoUrl": "https://example.com/ep1.mp4",
              "dateAdded": "2024-01-01"
            }
          }
        }
        */
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SGQZD7TYR0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-SGQZD7TYR0');
    </script>
</body>
</html>