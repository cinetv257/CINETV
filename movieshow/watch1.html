<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DRSJ4J6W6P"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DRSJ4J6W6P');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Watch | MovieShow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        :root {
            --bg: #000000;
            --panel: #111111;
            --panel-2: #1a1a1a;
            --text: #ffffff;
            --text-secondary: #cccccc;
            --muted: #888888;
            --brand: #03C771;
            --brand-light: #34d187;
            --brand-dark: #02a55c;
            --action: #03C771;
            --gradient: linear-gradient(135deg, #03C771 0%, #02a55c 100%);
            --white-element: #ffffff;
            --premium-color: #ffd700;
            --ad-color: #ff9800;
            --success: #4CAF50;
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ======= NAVBAR ======= */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 0 15px;
            background: #000000;
            border-bottom: 1px solid #333333;
        }
        
        .logo-img {
            width: 155px;
            height: 155px;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(3, 199, 113, 0.7));
        }

        /* ======= COVER PAGE ======= */
        .cover-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 70px 20px 30px;
        }

        .cover-content {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cover-poster {
            width: 100%;
            max-width: 300px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8);
            margin-bottom: 25px;
            border: 2px solid rgba(3, 199, 113, 0.3);
        }

        .cover-poster img {
            width: 100%;
            height: auto;
            display: block;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        .cover-info {
            width: 100%;
            text-align: center;
            margin-bottom: 30px;
        }

        .cover-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--white-element);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .cover-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .cover-meta-item {
            background: rgba(3, 199, 113, 0.15);
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--brand-light);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(3, 199, 113, 0.3);
        }

        .cover-meta-item i {
            color: var(--brand);
        }

        .cover-description {
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 1rem;
            margin-bottom: 25px;
            padding: 0 10px;
        }

        .cover-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .cover-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            width: 100%;
        }

        .watch-btn {
            background: var(--gradient);
            color: var(--white-element);
            box-shadow: 0 8px 25px rgba(3, 199, 113, 0.4);
        }

        .watch-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(3, 199, 113, 0.6);
        }

        .download-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white-element);
            border: 2px solid var(--brand);
        }

        .download-btn:hover {
            background: rgba(3, 199, 113, 0.2);
            transform: translateY(-3px);
        }

        /* ======= FULLSCREEN PLAYER ======= */
        .fullscreen-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            z-index: 300;
            display: none;
            flex-direction: column;
        }

        .player-header {
            height: 55px;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid #333333;
            z-index: 2;
        }

        .player-logo {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 0 8px rgba(3, 199, 113, 0.5));
        }

        .close-player {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--white-element);
            font-size: 1.8rem;
            cursor: pointer;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-player:hover {
            color: var(--brand);
            background: rgba(3, 199, 113, 0.1);
        }

        .video-container {
            flex: 1;
            position: relative;
            background: #000;
        }

        .video-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            background: #000000;
            color: var(--white-element);
            z-index: 1;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(3, 199, 113, 0.2);
            border-top: 3px solid var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ======= SERIES EPISODES IN PLAYER ======= */
        .episodes-sidebar {
            position: fixed;
            right: 0;
            top: 55px;
            bottom: 0;
            width: 300px;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(10px);
            z-index: 301;
            overflow-y: auto;
            padding: 20px;
            border-left: 1px solid #333333;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .episodes-sidebar.show {
            transform: translateX(0);
        }

        .episodes-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--brand);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .episodes-list-vertical {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .episode-card-vertical {
            background: var(--panel-2);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #333333;
            display: flex;
            gap: 15px;
            padding: 12px;
        }

        .episode-card-vertical:hover {
            border-color: var(--brand);
            background: rgba(3, 199, 113, 0.1);
            transform: translateX(-5px);
        }

        .episode-card-vertical.active {
            border-color: var(--brand);
            background: rgba(3, 199, 113, 0.2);
        }

        .episode-thumb {
            width: 80px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .episode-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .episode-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .episode-number {
            font-size: 0.8rem;
            color: var(--brand-light);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .episode-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--white-element);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .episode-duration {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .toggle-episodes {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: var(--gradient);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 302;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .toggle-episodes:hover {
            transform: scale(1.1);
        }

        /* ======= DOWNLOAD MODAL ======= */
        .download-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 400;
            padding: 20px;
        }

        .download-content {
            background: var(--panel);
            padding: 25px;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: auto;
            border: 2px solid var(--brand);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
        }

        .download-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333333;
        }

        .download-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--brand);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .download-quality {
            margin-bottom: 20px;
        }

        .quality-title {
            font-size: 1rem;
            color: var(--white-element);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .quality-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quality-option {
            padding: 15px;
            background: var(--panel-2);
            border-radius: 10px;
            border: 1px solid #333333;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quality-option:hover {
            border-color: var(--brand);
            background: rgba(3, 199, 113, 0.1);
        }

        .quality-name {
            font-weight: 600;
            color: var(--white-element);
        }

        .quality-size {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .download-instructions {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--ad-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .instructions-title {
            color: var(--ad-color);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ======= SIMILAR MOVIES ======= */
        .similar-movies {
            padding: 30px 4% 40px;
            background: var(--bg);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--brand);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .movie-card {
            position: relative;
            background: var(--panel-2);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            aspect-ratio: 2/3;
            border: 1px solid #333333;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            border-color: var(--brand);
            box-shadow: 0 10px 20px rgba(3, 199, 113, 0.2);
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .movie-card-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            color: var(--white-element);
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ======= FOOTER ======= */
        footer {
            background: #000000;
            padding: 30px 4%;
            text-align: center;
            border-top: 1px solid #333333;
        }

        .footer-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            display: block;
            filter: drop-shadow(0 0 10px rgba(3, 199, 113, 0.6));
        }

        .footer-social {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white-element);
            font-size: 1.2rem;
            transition: all 0.3s ease;
            text-decoration: none;
            border: 1px solid #333333;
        }

        .social-link:hover {
            background: var(--gradient);
            color: var(--white-element);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(3, 199, 113, 0.4);
        }

        .footer-bio {
            max-width: 500px;
            margin: 20px auto;
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.9rem;
            padding: 0 10px;
        }

        .copyright {
            color: var(--white-element);
            font-size: 0.8rem;
            margin-top: 20px;
            opacity: 0.8;
        }

        .designer-credit {
            color: var(--brand);
            font-size: 0.8rem;
            margin-top: 10px;
            font-style: italic;
        }

        /* ======= UTILITY CLASSES ======= */
        .hidden {
            display: none !important;
        }

        /* ======= RESPONSIVE ======= */
        @media (max-width: 768px) {
            .cover-title {
                font-size: 1.5rem;
            }
            
            .cover-meta {
                gap: 8px;
            }
            
            .cover-meta-item {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .cover-btn {
                padding: 16px 24px;
                font-size: 1rem;
            }
            
            .episodes-sidebar {
                width: 100%;
            }
            
            .movies-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .cover-page {
                padding: 60px 15px 20px;
            }
            
            .cover-poster {
                max-width: 250px;
            }
            
            .cover-title {
                font-size: 1.3rem;
            }
            
            .cover-description {
                font-size: 0.9rem;
            }
            
            .cover-meta-item {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            .movies-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }

        /* Animation for cards */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .movie-card {
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }

        .movie-card:nth-child(1) { animation-delay: 0.1s; }
        .movie-card:nth-child(2) { animation-delay: 0.15s; }
        .movie-card:nth-child(3) { animation-delay: 0.2s; }
        .movie-card:nth-child(4) { animation-delay: 0.25s; }
        .movie-card:nth-child(5) { animation-delay: 0.3s; }
        .movie-card:nth-child(6) { animation-delay: 0.35s; }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar">
        <div class="logo-container">
            <img src="logo.png" class="logo-img" alt="MovieShow">
        </div>
    </nav>
    
    <!-- Cover Page (First View) -->
    <div class="cover-page" id="coverPage">
        <div class="cover-content">
            <div class="cover-poster" id="coverPoster">
                <!-- Poster will be loaded here -->
            </div>
            
            <div class="cover-info">
                <h1 class="cover-title" id="coverTitle"></h1>
                
                <div class="cover-meta" id="coverMeta">
                    <!-- Meta info will be loaded here -->
                </div>
                
                <div class="cover-description" id="coverDescription"></div>
            </div>
            
            <div class="cover-actions">
                <button class="cover-btn watch-btn" id="watchButton">
                    <i class="fas fa-play"></i>
                    <span>Watch Movie</span>
                </button>
                
                <button class="cover-btn download-btn" id="downloadCoverButton">
                    <i class="fas fa-download"></i>
                    <span>Download Movie</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen Player -->
    <div class="fullscreen-player" id="fullscreenPlayer">
        <div class="player-header">
            <img src="logo.png" class="player-logo" alt="MovieShow">
            <button class="close-player" id="closePlayer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="video-container">
            <div class="loading-video" id="loadingVideo">
                <div class="loading-spinner"></div>
                <div>Loading video...</div>
            </div>
            <iframe class="video-iframe" id="videoIframe" allowfullscreen></iframe>
        </div>
        
        <!-- Series episodes sidebar -->
        <div class="episodes-sidebar" id="episodesSidebar">
            <h3 class="episodes-title">
                <i class="fas fa-list"></i>
                <span id="episodesCount">Episodes</span>
            </h3>
            <div class="episodes-list-vertical" id="episodesListVertical">
                <!-- Episodes will be loaded here -->
            </div>
        </div>
        
        <!-- Toggle episodes button (for series) -->
        <div class="toggle-episodes" id="toggleEpisodes">
            <i class="fas fa-list"></i>
        </div>
    </div>
    
    <!-- Download Modal -->
    <div class="download-modal" id="downloadModal">
        <div class="download-content">
            <div class="download-header">
                <h3 class="download-title">
                    <i class="fas fa-download"></i>
                    Download Options
                </h3>
                <button class="close" id="closeDownload">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="download-quality" id="downloadQuality">
                <!-- Quality options will be loaded here -->
            </div>
            
            <div class="download-instructions">
                <div class="instructions-title">
                    <i class="fas fa-info-circle"></i>
                    Download Instructions
                </div>
                <div class="instructions-text">
                    1. Select your preferred quality<br>
                    2. Click the download link<br>
                    3. Video will start downloading from Google Drive
                </div>
            </div>
        </div>
    </div>
    
    <!-- Similar Movies Section -->
    <section class="similar-movies" id="similarMoviesSection">
        <h3 class="section-title">
            <i class="fas fa-film"></i>
            Similar Movies
        </h3>
        <div class="movies-grid" id="similarMoviesGrid">
            <!-- Similar movies will be loaded here -->
        </div>
    </section>
    
    <!-- Footer -->
    <footer>
        <img src="logo.png" class="footer-logo" alt="MovieShow">
        
        <div class="footer-social">
            <a href="https://facebook.com/audrypaulin.dushime.7" class="social-link" target="_blank">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href="https://wa.me/25776389163" class="social-link" target="_blank">
                <i class="fab fa-whatsapp"></i>
            </a>
            <a href="mailto:support@movieshow.com" class="social-link">
                <i class="fas fa-envelope"></i>
            </a>
        </div>

        <div class="footer-bio">
            MovieShow is your ultimate streaming platform for movies and TV series. 
            Enjoy unlimited entertainment with our constantly updated library. 
            Stream anytime, anywhere on any device.
        </div>

        <div class="copyright">
            &copy; 2025 MovieShow. All rights reserved.
        </div>
        <div class="designer-credit">
            Designed by @audrypaulin
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB77EmeaPTvtXCH4EL-1E1SgmyW6Yz9lLI",
            authDomain: "cinetv257.firebaseapp.com",
            projectId: "cinetv257",
            storageBucket: "cinetv257.appspot.com",
            messagingSenderId: "402664770835",
            appId: "1:402664770835:web:1adaea98f40ca609645ee6"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Get movie ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        const episodeId = urlParams.get('episode');
        const partId = urlParams.get('part');

        // Default video URL (fake video first)
        const DEFAULT_VIDEO_URL = "https://drive.google.com/file/d/1PsAxqd5gTMluA2_cKWQjsTEoI09JrVeM/view?usp=drivesdk";
        
        // Current movie data
        let currentMovie = null;
        let currentVideoUrl = '';
        let isSeries = false;
        let currentEpisodes = [];

        // Check if movie ID is present
        if (!movieId) {
            // Show error message and redirect
            document.getElementById('coverPage').innerHTML = `
                <div class="cover-content" style="justify-content: center;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--brand); margin-bottom: 20px;"></i>
                        <h2 style="color: var(--white-element); margin-bottom: 15px;">No Movie Selected</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">You will be redirected to the homepage...</p>
                        <a href="home.html" style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: var(--gradient); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                            <i class="fas fa-home"></i>
                            Return to Home
                        </a>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                window.location.href = 'home.html';
            }, 3000);
        } else {
            // Load movie data
            loadMovieData();
        }

        // Function to create movie card
        function makeCard(key, movie) {
            const a = document.createElement('a');
            a.href = `watch.html?id=${key}`;
            a.className = 'movie-card';
            a.innerHTML = `
                <img src="${movie.imageUrl || ''}" alt="${movie.title || ''}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                <div class="movie-card-title">${movie.title || ''}</div>
            `;
            return a;
        }

        // Load movie data
        function loadMovieData() {
            const movieRef = database.ref(`movies/${movieId}`);
            
            movieRef.on('value', (snapshot) => {
                const movie = snapshot.val();
                
                if (movie) {
                    currentMovie = movie;
                    
                    // Set flags
                    isSeries = movie.type === 'series';
                    
                    // Determine video URL
                    if (isSeries && movie.episodes) {
                        currentEpisodes = movie.episodes;
                        const episodeKeys = Object.keys(currentEpisodes);
                        const defaultEpisodeId = episodeId || episodeKeys[0];
                        
                        if (currentEpisodes[defaultEpisodeId]) {
                            currentVideoUrl = currentEpisodes[defaultEpisodeId].videoUrl;
                        }
                    } else if (movie.type === 'multi-part' && movie.parts) {
                        const parts = movie.parts;
                        const partKeys = Object.keys(parts);
                        const defaultPartId = partId || partKeys[0];
                        
                        if (parts[defaultPartId]) {
                            currentVideoUrl = parts[defaultPartId].videoUrl;
                        }
                    } else {
                        currentVideoUrl = movie.videoUrl;
                    }
                    
                    // Update cover page
                    updateCoverPage(movie);
                    
                    // Load similar movies
                    loadSimilarMovies(movieId, movie.category);
                } else {
                    showError("Movie not found");
                }
            });
        }

        // Update cover page
        function updateCoverPage(movie) {
            // Update poster
            const coverPoster = document.getElementById('coverPoster');
            if (movie.imageUrl) {
                coverPoster.innerHTML = `<img src="${movie.imageUrl}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">`;
            }
            
            // Update title
            document.getElementById('coverTitle').textContent = movie.title || 'Movie Title';
            
            // Update meta info
            const coverMeta = document.getElementById('coverMeta');
            coverMeta.innerHTML = '';
            
            if (movie.interpreter) {
                const metaItem = document.createElement('div');
                metaItem.className = 'cover-meta-item';
                metaItem.innerHTML = `<i class="fas fa-user"></i><span>${movie.interpreter}</span>`;
                coverMeta.appendChild(metaItem);
            }
            
            if (movie.year) {
                const metaItem = document.createElement('div');
                metaItem.className = 'cover-meta-item';
                metaItem.innerHTML = `<i class="fas fa-calendar"></i><span>${movie.year}</span>`;
                coverMeta.appendChild(metaItem);
            }
            
            if (movie.duration) {
                const metaItem = document.createElement('div');
                metaItem.className = 'cover-meta-item';
                metaItem.innerHTML = `<i class="fas fa-clock"></i><span>${movie.duration}</span>`;
                coverMeta.appendChild(metaItem);
            }
            
            if (movie.type) {
                const metaItem = document.createElement('div');
                metaItem.className = 'cover-meta-item';
                metaItem.innerHTML = `<i class="fas fa-${movie.type === 'series' ? 'tv' : 'film'}"></i><span>${movie.type}</span>`;
                coverMeta.appendChild(metaItem);
            }
            
            // Update description
            const coverDescription = document.getElementById('coverDescription');
            if (movie.description) {
                coverDescription.textContent = movie.description;
            } else {
                coverDescription.textContent = 'No description available.';
            }
            
            // Update episodes count for series
            if (isSeries && currentEpisodes) {
                const episodesCount = document.getElementById('episodesCount');
                const episodeKeys = Object.keys(currentEpisodes);
                episodesCount.textContent = `Episodes (${episodeKeys.length})`;
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('coverPage').innerHTML = `
                <div class="cover-content" style="justify-content: center;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: var(--brand); margin-bottom: 20px;"></i>
                        <h2 style="color: var(--white-element); margin-bottom: 15px;">Error</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">${message}</p>
                        <a href="home.html" style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: var(--gradient); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                            <i class="fas fa-home"></i>
                            Return to Home
                        </a>
                    </div>
                </div>
            `;
        }

        // Load similar movies
        function loadSimilarMovies(currentMovieId, categories) {
            if (!categories || categories.length === 0) return;
            
            const moviesRef = database.ref('movies');
            const similarMoviesGrid = document.getElementById('similarMoviesGrid');
            
            moviesRef.once('value').then((snapshot) => {
                const movies = snapshot.val();
                const similarMovies = [];
                
                // Filter similar movies
                for (const [id, movie] of Object.entries(movies)) {
                    if (id !== currentMovieId && movie.category && 
                        movie.category.some(cat => categories.includes(cat))) {
                        similarMovies.push({ id, ...movie });
                    }
                }
                
                // Sort by popularity and limit to 6
                const topSimilar = similarMovies.slice(0, 6);
                
                // Display similar movies
                similarMoviesGrid.innerHTML = '';
                if (topSimilar.length > 0) {
                    topSimilar.forEach(movie => {
                        similarMoviesGrid.appendChild(makeCard(movie.id, movie));
                    });
                } else {
                    similarMoviesGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary);">No similar movies found</p>';
                }
            });
        }

        // Extract Google Drive download link
        function getGoogleDriveDownloadUrl(driveUrl) {
            // Convert Google Drive view URL to download URL
            if (driveUrl.includes('drive.google.com/file/d/')) {
                const fileIdMatch = driveUrl.match(/\/d\/([^\/]+)/);
                if (fileIdMatch && fileIdMatch[1]) {
                    return `https://drive.google.com/uc?export=download&id=${fileIdMatch[1]}`;
                }
            }
            return driveUrl;
        }

        // Show download options
        function showDownloadOptions() {
            const downloadModal = document.getElementById('downloadModal');
            const downloadQuality = document.getElementById('downloadQuality');
            
            downloadQuality.innerHTML = '';
            
            if (!currentMovie) return;
            
            // Create quality options
            const title = document.createElement('div');
            title.className = 'quality-title';
            title.textContent = 'Select Quality:';
            downloadQuality.appendChild(title);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'quality-options';
            
            // Add quality options based on movie data
            const qualities = [];
            
            // Check if movie has quality info
            if (currentMovie.quality) {
                qualities.push({
                    name: currentMovie.quality,
                    url: currentVideoUrl,
                    size: 'Size varies'
                });
            } else {
                // Default quality options
                qualities.push({
                    name: 'HD 720p',
                    url: currentVideoUrl,
                    size: '1.2 GB'
                });
                
                qualities.push({
                    name: 'SD 480p',
                    url: currentVideoUrl.replace(/\/[^\/]+$/, '/sd') || currentVideoUrl,
                    size: '600 MB'
                });
            }
            
            // Create download links
            qualities.forEach((quality, index) => {
                const option = document.createElement('a');
                option.className = 'quality-option';
                option.href = getGoogleDriveDownloadUrl(quality.url);
                option.target = '_blank';
                option.download = `${currentMovie.title || 'movie'}_${quality.name}.mp4`;
                
                option.innerHTML = `
                    <div class="quality-name">${quality.name}</div>
                    <div class="quality-size">${quality.size}</div>
                `;
                
                optionsContainer.appendChild(option);
            });
            
            downloadQuality.appendChild(optionsContainer);
            
            // Show modal
            downloadModal.style.display = 'flex';
        }

        // Play video with fake URL first, then real URL
        function playVideo() {
            const fullscreenPlayer = document.getElementById('fullscreenPlayer');
            const videoIframe = document.getElementById('videoIframe');
            const loadingVideo = document.getElementById('loadingVideo');
            const coverPage = document.getElementById('coverPage');
            
            // Show player, hide cover
            fullscreenPlayer.style.display = 'flex';
            coverPage.style.display = 'none';
            
            // Load fake video first
            videoIframe.src = DEFAULT_VIDEO_URL;
            loadingVideo.style.display = 'flex';
            
            // After 3 seconds, load real video
            setTimeout(() => {
                videoIframe.src = currentVideoUrl;
                loadingVideo.style.display = 'none';
            }, 3000);
            
            // Load episodes if it's a series
            if (isSeries && currentEpisodes) {
                loadEpisodesSidebar();
            }
        }

        // Load episodes in sidebar
        function loadEpisodesSidebar() {
            const episodesList = document.getElementById('episodesListVertical');
            if (!episodesList || !currentEpisodes) return;
            
            episodesList.innerHTML = '';
            const episodeKeys = Object.keys(currentEpisodes);
            
            episodeKeys.forEach((key, index) => {
                const episode = currentEpisodes[key];
                const isActive = (episodeId === key) || (!episodeId && index === 0);
                
                const episodeCard = document.createElement('div');
                episodeCard.className = `episode-card-vertical ${isActive ? 'active' : ''}`;
                episodeCard.setAttribute('data-episode-id', key);
                
                episodeCard.innerHTML = `
                    <div class="episode-thumb">
                        <img src="${episode.imageUrl || currentMovie.imageUrl || 'https://via.placeholder.com/80x100?text=No+Image'}" 
                             alt="${episode.title || `Episode ${index + 1}`}">
                    </div>
                    <div class="episode-info">
                        <div class="episode-number">Episode ${index + 1}</div>
                        <div class="episode-name">${episode.title || `Episode ${index + 1}`}</div>
                        <div class="episode-duration">${episode.duration || 'N/A'}</div>
                    </div>
                `;
                
                episodeCard.addEventListener('click', function() {
                    const episodeId = this.getAttribute('data-episode-id');
                    window.location.href = `watch.html?id=${movieId}&episode=${episodeId}`;
                });
                
                episodesList.appendChild(episodeCard);
            });
        }

        // Initialize event listeners
        function initEventListeners() {
            // Watch button
            document.getElementById('watchButton').addEventListener('click', playVideo);
            
            // Download button on cover
            document.getElementById('downloadCoverButton').addEventListener('click', showDownloadOptions);
            
            // Close player button
            document.getElementById('closePlayer').addEventListener('click', function() {
                document.getElementById('fullscreenPlayer').style.display = 'none';
                document.getElementById('coverPage').style.display = 'flex';
                document.getElementById('videoIframe').src = '';
            });
            
            // Close download modal
            document.getElementById('closeDownload').addEventListener('click', function() {
                document.getElementById('downloadModal').style.display = 'none';
            });
            
            // Toggle episodes sidebar
            const toggleEpisodes = document.getElementById('toggleEpisodes');
            const episodesSidebar = document.getElementById('episodesSidebar');
            
            if (toggleEpisodes && episodesSidebar) {
                toggleEpisodes.addEventListener('click', function() {
                    episodesSidebar.classList.toggle('show');
                });
            }
            
            // Close modals on overlay click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initEventListeners);
    </script>

    <!-- Ad System Script -->
    <script>
        // Ad system configuration
        const ADSTERRA_SMARTLINK = "https://www.effectivegatecpm.com/wu0xndpxcg?key=962747162b526b8e35632b7e46f1e881";
        
        // Delays in milliseconds
        const delayFirstOpen = 10 * 60 * 1000;  // 10 minutes = 600,000 ms
        const repeatInterval = 15 * 60 * 1000;   // 15 minutes = 900,000 ms

        // Function to open ad URL
        function openAdUrl() {
            window.open(ADSTERRA_SMARTLINK, '_blank');
            console.log("Opening ad URL.");
        }

        // Function to check if user is premium
        function isPremiumUser() {
            return localStorage.getItem('movieshow_premium') === 'true';
        }

        // Only run ad system for non-premium users
        if (!isPremiumUser()) {
            // 1. Schedule FIRST opening after 10 minutes
            setTimeout(() => {
                openAdUrl(); // Execute first opening
                console.log("First ad opening after 10 minutes.");

                // 2. Schedule REPEAT opening every 15 minutes
                setInterval(openAdUrl, repeatInterval);
                
            }, delayFirstOpen);
        } else {
            console.log("Premium user detected - ads disabled.");
        }
    </script>
</body>
</html>